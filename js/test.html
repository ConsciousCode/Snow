<!DOCTYPE html>
<html>
	<head>
		<title>JS Snow test</title>
		<script src="snow.js"></script>
	</head>
	<body>
		<script>
			var pass=document.createElement("span"),
				fail=document.createElement("summary");
			pass.style.color="green";
			pass.appendChild(document.createTextNode("pass"));
			
			fail.style.color="red";
			fail.appendChild(document.createTextNode("fail");
			
			function test(name,file){
				var div=document.createElement("div");
				div.appendChild(document.createTextNode(name+": "));
				document.appendChild(div);
				
				var req=new XMLHttpRequest();
				req.onload=function(){
					var x=this.responseText.split("~~");
					try{
						var doc=snow.parse(x[0]);
					}
					catch(e){
						var d=document.createElement("details"),
							s=document.createElement("summary"),
							p=document.createElement("p");
						
						s.appendChild(
							document.createTextNode("Fatal exception")
						);
						p.appendChild(document.createTextNode(
							e.stack.replace(/\n/g,"<br/>")
						));
						
						d.appendChild(s);
						d.appendChild(p);
						
						div.appendChild(d);
						return;
					}
					
					var t=doc.visit({
						visit_doc:function(doc){
							return "("+doc.value.length+doc.map(function(v){
								return v.visit(this);
							},this).join("")+")";
						},
						visit_tag:function(tag){
							var p=tag.pos,k=tag.keys,v=tag.vals;
							return "{"+p.length+p.map(function(x){
								return x.visit(this);
							},this).join("")+k.length+k.map(function(x,i){
								return x.visit(this)+v[i].visit(this);
							},this).join("")+"}";
						},
						visit_section:function(sec){
							return "["+sec.value.length+sec.map(function(v){
								return v.visit(this);
							},this).join("")+"]";
						},
						visit_text:function(text){
							var v=text.value;
							return '"'+v.length+v.replace(/[^ -~]/,function(m){
								if(m[0]=='\0'){
									return "~.";
								}
								return "~"+m[0].charCodeAt(0).
									toString(16).toUpperCase()+".";
							})+'"';
						}
					});
					
					if(t==x[1]){
						div.appendchild(pass);
					}
					else{
						var fail=document.createElement("details"),
							p=document.createElement("p");
						
						p.appendChild(document.createTextNode(
							"Got "+t+",<br/><br/>expected "+x[1]
						));
					}
				}
				
				req.open("get","https://raw.githubusercontent.com/"+
					"ConsciousCode/Snow/master/tests/"+file+".test",
					true
				);
				req.send();
			}
			
			//Functionality
			test("Basic","basic");
			test("Non-textual name","nontextual-name");
			test("Escapes","escapes");
			test("Control characters","control-chars");
			test("Unicode","unicode");
			test("Newline","newline");
			
			var h3=document.createElement("h3");
			h3.appendChild(document.createTextNode("Error handling"));
			document.appendChild(h3);
			
			//Errors
			test("Tag EOF","tag-eof");
			test("Section EOF","section-eof");
			test("Double quote EOF","dq-eof");
			test("Single quote EOF","sq-eof");
			test("Backtick EOF","bq-eof");
			test("Unescaped brace","unescaped-brace");
			test("Unexpected colon","unexpected-colon");
			test("Valueless attribute","valueless-attr");
			test("Duplicate attribute","duplicate-attr");
		</script>
	</body>
</html>